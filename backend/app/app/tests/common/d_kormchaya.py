import logging
from pathlib import Path
from typing import TypeAlias

from pydantic.color import Color
from sqlalchemy.orm import Session

from app import utils, models, crud
from app.api import deps
from app.create.prepare.manuscript.bookmark.common import get_pdf_writer, add_bookmarks, save_pdf
from app.create.prepare.manuscript.bookmark.get_bookmarks import Bookmark
from app.create.prepare.manuscript.bookmark.lls_bookmarks import _ColorHex

KormchayaBookTitleType: TypeAlias = str

KormchayaBookType: TypeAlias = list[tuple[int, list[tuple[KormchayaBookTitleType, int]]]]

KormchayaBookFullType: TypeAlias = tuple[KormchayaBookType, int]

logging.basicConfig(level=logging.INFO, format='%(levelname)s:%(message)s')


class KormchayaBookmarkBase(Bookmark):
    start_on_new_page: bool


class KormchayaBookmark(KormchayaBookmarkBase):
    pass



f_304i_206: KormchayaBookFullType = (
    [
        ('1',),
        ('2',),
        ('3',),
        ('4',),
        ('5',),
        ('6',),
        ('7',),
        ('8',),
        ('9',),
        ('10',),
        ('11',),
        ('12',),
        ('13',),
        ('14',),
        ('15',),
        ('16',),
        ('17',),
        ('18',),
        ('19',),
        ('20',),
        ('21',),
        ('22',),
        ('23',),
        ('24',),
        ('25',),
        ('26',),
        ('27',),
        ('28',),
        ('29',),
        ('30', 256),
        ('31', 256),
        ('32', 257),
        ('33', 258),
        ('34', 258),
        ('35', 260),
        ('36', 262),
        ('37', 262),
        ('38', 263),
        ('39', 263),
        ('40', 264),
        ('41', 264),
        ('42 ?', 267),
        ('43', 268),
        ('44', 269),
        ('45', 270),
        ('46', 271),
        ('47', 272),
        ('48', 275),
        ('49', 277),
        ('50', 282),
        ('51', 296),
        ('52', 301),
        ('53 ?', 302),
        ('54 ?', 303),
        ('55', 303),
        ('56', 304),
        ('57', 305),
        ('58', 306),
        ('59', 322),
        ('60', 322),
        ('61', 323),
        ('62', 325),
        ('63', 325),
        ('64', 326),
        ('65', 329),
        ('66 ?', 1),
        ('67', 335),
        ('68', 336),
        ('69', 336),
        ('70 ?', 342),
        ('71', 343),
        ('72', 343),
        ('73', 345),
        ('74', 347),
        ('75', 350),
        ('76', 353),
        ('77', 357),
        ('78', 360),
        ('79', 362),
        ('80', 363),
        ('81', 393),
        ('82 ?', 397),
        ('83', 402),
        ('84 ? О пострижении бороды', 409),
        ('85', 410),
        ('86 ?', 413),
        ('87',),
        ('88', 435),
        ('89', 445),
        ('90', 447),
        ('91 ?', 1),
        ('92', 455),
        ('93', 455),
        ('94', 456),
        ('95', 456),
        ('96', 457),
        ('97', 458),
        ('98', 461),
        ('99', 464),
        ('100', 468),
        ('101', 471),
        ('102 ?', 1),
        ('103 ?', 1),
        ('104', 549),
        ('105 ?', 1),
        ('106', 572),
        ('107', 576),
        ('108 ?', 1),
        ('109 ?', 1),
    ], 0)

kormchaya_3: KormchayaBookFullType = (
    [
        ('1',),
        ('2',),
        ('3',),
        ('4',),
        ('5',),
        ('6',),
        ('7',),
        ('8',),
        ('9',),
        ('10',),
        ('11',),
        ('12',),
        ('13',),
        ('14',),
        ('15',),
        ('16',),
        ('17',),
        ('18',),
        ('19',),
        ('20',),
        ('21',),
        ('22',),
        ('23',),
        ('24',),
        ('25',),
        ('26',),
        ('27',),
        ('28',),
        ('29',),
        ('30', 408),
        ('31', 409),
        ('32', 409),
        ('33', 411),
        ('34', 413),
        ('35', 415),
        ('36', 419),
        ('37', 420),
        ('38', 421),
        ('39', 422),
        ('40', 422),
        ('41', 423),
        ('42', 431),
        ('43', 433),
        ('44', 433),
        ('45', 435),
        ('46', 439),
        ('47', 441),
        ('48', 446),
        ('49', 451),
        ('50', 461),
        ('51', 488),
        ('52', 498),
        ('53', 501),
        ('54', 502),
        ('55', 503),
        ('56', 504),
        ('57', 505),
        ('58', 506),
        ('59', 526),
        ('60', 526),
        ('61', 528),
        ('62', 529),
        ('63', 529),
        ('64', 531),
        ('65', 535),
        ('66', 541),
        ('67', 543),
        ('68', 544),
        ('69', 544),
        ('70', 550),
        ('71', 553),
        ('72', 554),
        ('73', 557),
        ('74', 559),
        ('75', 564),
        ('76', 568),
        ('77', 572),
        ('78', 577),
        ('79', 580),
        ('80', 581),
        ('81', 623),
        ('82', 629),
        ('83', 635),
        ('84', 641),
        ('85', 646),
        ('86', 650),
        ('87', 651),
        ('88', 681),
        ('89', 698),
        ('90', 701),
        ('91', 710),
        ('92', 713),
        ('93', 714),
        ('94', 714),
        ('95', 714),
        ('96', 717),
        ('97', 719),
        ('98', 722),
        ('99', 727),
        ('100', 734),
        ('101', 740),
        ('102', 747),
        ('103', 755),
        ('104', 860),
        ('105', 896),
        ('106', 899),
        ('107', 905),
        ('108', 913),
        ('109', 918),

    ], 0)

kormchaya_4: KormchayaBookFullType = (
    [
        ('1',),
        ('2',),
        ('3',),
        ('4',),
        ('5',),
        ('6',),
        ('7',),
        ('8',),
        ('9',),
        ('10',),
        ('11',),
        ('12',),
        ('13',),
        ('14',),
        ('15',),
        ('16',),
        ('17',),
        ('18',),
        ('19',),
        ('20',),
        ('21',),
        ('22',),
        ('23',),
        ('24',),
        ('25',),
        ('26',),
        ('27',),
        ('28',),
        ('29',),
        ('30', 496),
        ('31', 496),
        ('32', 498),
        ('33', 499),
        ('34', 500),
        ('35', 503),
        ('36', 506),
        ('37', 507),
        ('38', 508),
        ('39', 509),
        ('40', 509),
        ('41', 510),
        ('42', 516),
        ('43', 517),
        ('44', 518),
        ('45', 519),
        ('46', 523),
        ('47', 524),
        ('48', 529),
        ('49', 534),
        ('50', 543),
        ('51', 561),
        ('52', 574),
        ('53', 577),
        ('54', 577),
        ('55', 577),
        ('56', 580),
        ('57', 581),
        ('58', 583),
        ('59', 610),
        ('60', 610),
        ('61', 612),
        ('62', 614),
        ('63', 614),
        ('64', 617),
        ('65', 622),
        ('66', 629),
        ('67', 632),
        ('68', 633),
        ('69', 634),
        ('70', 641),
        ('71', 644),
        ('72', 645),
        ('73', 649),
        ('74', 651),
        ('75', 657),
        ('76', 662),
        ('77', 667),
        ('78', 672),
        ('79', 675),
        ('80', 677),
        ('81', 725),
        ('82', 732),
        ('83', 740),
        ('84', 747),
        ('85', 753),
        ('86', 756),
        ('87', 758),
        ('88', 792),
        ('89',),
        ('90',),
        ('91',),
        ('92',),
        ('93',),
        ('94',),
        ('95',),
        ('96',),
        ('97',),
        ('98',),
        ('99',),
        ('100',),
        ('101', 854),
        ('102',),
        ('103', 870),
        ('104',),
        ('105',),
        ('106',),
        ('107',),
        ('108',),
        ('109',)
    ], 0)

kormchaya_pisec_sava_danilov: KormchayaBookFullType = (
    [
        ('1',),
        ('2',),
        ('3',),
        ('4',),
        ('5',),
        ('6',),
        ('7',),
        ('8',),
        ('9',),
        ('10',),
        ('11',),
        ('12',),
        ('13',),
        ('14',),
        ('15',),
        ('16',),
        ('17',),
        ('18',),
        ('19',),
        ('20',),
        ('21',),
        ('22',),
        ('23',),
        ('24',),
        ('25',),
        ('26', 516),
        ('27', 516),
        ('28', 517),
        ('29', 519),
        ('30', 521),
        ('31', 524),
        ('32', 527),
        ('33', 528),
        ('34', 529),
        ('35', 529),
        ('36', 530),
        ('37', 536),
        ('38', 540),
        ('39', 542),
        ('40', 546),
        ('41', 564),
        ('42', 578),
        ('43', 582),
        ('44', 600),
        ('45', 604),
        ('46', 618),
        ('47', 619),
        ('48', 628),
        ('49', 635),
        ('50', 639),
        ('51', 641),
        ('52', 645),
        ('53', 650),
        ('54', 652),
        ('55', 660),
        ('56', 665),
        ('57', 668),
        ('58', 671),
        ('59', 677),
        ('60', 689),
        ('61', 697),
        ('62', 699),
        ('63', 702),
        ('64', 714),
        ('65', 720),
        ('66', 724),
        ('67', 734),
        ('68', 737),
        ('69', 746),
        ('70', 762),
        ('71', 767),
        ('72', 770),
        ('73', 775),
        ('74', 777),
        ('75', 787),
        ('76', 806),
        ('77', 812),
        ('78', 814),
        ('79', 815),
        ('80', 823),
        ('81', 830),
        ('82', 832),
        ('83', 833),
        ('84', 835),
        ('85', 844),
        ('86', 846),
        ('87', 848),
        ('88', 851),
        ('89', 853),
        ('90', 858),
        ('91', 865),
        ('92', 873),
        ('93', 883),
        ('94', 888),
    ], 0)


def get_kormchaya_bookmarks(kormchaya_book: KormchayaBookFullType) -> list[KormchayaBookmark]:
    kormchaya_bookmarks: list[KormchayaBookmark] = []
    start_on_new_page: bool = False
    for tuple_ in kormchaya_book[0]:
        if len(tuple_) == 1:
            title, page_num = tuple_[0], 1
            title += ' ?'
        else:
            title, page_num = tuple_
        num: int = int(title.split(' ')[0])
        color: Color | None = Color(_ColorHex.red_darken_2.value) if '?' not in title else None
        bookmark = KormchayaBookmark(
            page_num=page_num,
            start_on_new_page=start_on_new_page,
            title=f'Правило {utils.Cyrillic.to_cyrillic(num)} ({num})',
            color=color,
        )
        kormchaya_bookmarks.append(bookmark)
    return kormchaya_bookmarks


def get_manuscript_created_pdf_path(
        manuscript: models.Manuscript
) -> Path:
    try:
        created_pdf_path: Path = utils.PrepareManuscriptPathFactory.from_lib(
            fund_title=manuscript.fund.title,
            library_title=manuscript.fund.library,
            code=manuscript.code,
        ).created_pdf_path
    except FileNotFoundError as e:
        raise ValueError(e.args[0])
    return created_pdf_path


if __name__ == '__main__':
    for code, kormchaya_book in [
                    ('f-304i-206', f_304i_206),
                    ('e40b1692-8a78-4543-8495-3aa0c4e1deee', kormchaya_3),
                    ('fbcc305d-7632-44bb-8264-d18e4df174ac', kormchaya_4),
                    ('ba4b7090-357d-49b9-9d7d-35ce714b6236', kormchaya_pisec_sava_danilov)
                ]:
        db: Session = next(deps.get_db())
        manuscript: models.Manuscript = crud.manuscript.get_by_code(db, code=code)
        created_pdf_path = get_manuscript_created_pdf_path(manuscript)
        writer = get_pdf_writer(created_pdf_path)
        bookmarks = get_kormchaya_bookmarks(kormchaya_book)
        add_bookmarks(writer, bookmarks=bookmarks)
        save_pdf(writer, path=created_pdf_path)
        logging.info(created_pdf_path)
