import logging
from pathlib import Path
from typing import TypeAlias

from pydantic.color import Color
from sqlalchemy.orm import Session

from app import utils, models, crud
from app.api import deps
from app.create.prepare.manuscript.bookmark.common import get_pdf_writer, add_bookmarks, save_pdf
from app.create.prepare.manuscript.bookmark.get_bookmarks import Bookmark
from app.create.prepare.manuscript.bookmark.lls_bookmarks import _ColorHex

PsaltyrBookTitleType: TypeAlias = str

PsaltyrBookType: TypeAlias = list[tuple[int, list[tuple[PsaltyrBookTitleType, int]]]]

PsaltyrBookFullType: TypeAlias = tuple[PsaltyrBookType, int]

logging.basicConfig(level=logging.INFO, format='%(levelname)s:%(message)s')


class PsaltyrBookmarkBase(Bookmark):
    start_on_new_page: bool


class PsaltyrBookmark(PsaltyrBookmarkBase):
    pass


f_304i_87: PsaltyrBookFullType = (
    [
        ('1', 18),
        ('2', 20),
        ('3', 22),
        ('4', 23),
        ('5', 25),
        ('6', 27),
        ('7', 29),
        ('8', 32),
        ('9', 34),
        ('10', 40),
        ('11', 42),
        ('12', 44),
        ('13', 45),
        ('14', 47),
        ('15', 48),
        ('16', 50),
        ('17', 52),
        ('18', 59),
        ('19', 62),
        ('20', 63),
        ('21', 65),
        ('22', 70),
        ('23', 71),
        ('24', 72),
        ('25', 75),
        ('26', 77),
        ('27', 80),
        ('28', 81),
        ('29', 83),
        ('30', 85),
        ('31', 89),
        ('32', 91),
        ('33', 94),
        ('34', 96),
        ('35', 100),
        ('36', 102),
        ('37', 108),
        ('38', 111),
        ('39', 114),
        ('40', 118),
        ('41', 120),
        ('42', 123),
        ('43', 124),
        ('44', 128),
        ('45', 131),
        ('46', 133),
        ('47', 134),
        ('48', 136),
        ('49', 139),
        ('50', 143),
        ('51', 146),
        ('52', 148),
        ('53', 149),
        ('54', 150),
        ('55', 155),
        ('56', 157),
        ('57', 159),
        ('58', 160),
        ('59', 164),
        ('60', 166),
        ('61', 167),
        ('62', 170),
        ('63', 172),
        ('64', 174),
        ('65', 176),
        ('66', 179),
        ('67', 180),
        ('68', 187),
        ('69', 193),
        ('70', 194),
        ('71', 198),
        ('72', 201),
        ('73', 205),
        ('74', 210),
        ('75', 211),
        ('76', 213),
        ('77', 216),
        ('78', 226),
        ('79', 229),
        ('80', 232),
        ('81', 234),
        ('82', 235),
        ('83', 238),
        ('84', 240),
        ('85', 242),
        ('86', 244),
        ('87', 246),
        ('88', 249),
        ('89', 255),
        ('90', 258),
        ('91', 260),
        ('92', 263),
        ('93', 264),
        ('94', 267),
        ('95', 269),
        ('96', 271),
        ('97', 273),
        ('98', 275),
        ('99', 277),
        ('100', 278),
        ('101', 280),
        ('102', 284),
        ('103', 288),
        ('104', 293),
        ('105', 298),
        ('106', 304),
        ('107', 311),
        ('108', 313),
        ('109', 319),
        ('110', 320),
        ('111', 322),
        ('112', 324),
        ('113', 325),
        ('114', 329),
        ('115', 331),
        ('116', 332),
        ('117', 333),
        ('118 тут много, может быть тоже как-то разметить', 337),
        ('119', 367),
        ('120', 369),
        ('121', 370),
        ('122', 372),
        ('123', 373),
        ('124', 374),
        ('125', 375),
        ('126', 376),
        ('127', 378),
        ('128', 379),
        ('129', 380),
        ('130', 381),
        ('131', 382),
        ('132', 385),
        ('133', 386),
        ('134', 387),
        ('135', 389),
        ('136', 392),
        ('137', 394),
        ('138', 395),
        ('139', 399),
        ('140', 402),
        ('141', 404),
        ('142', 406),
        ('143', 408),
        ('144', 410),
        ('145', 413),
        ('146', 414),
        ('147', 416),
        ('148', 417),
        ('149', 419),
        ('150', 420),
    ], 0)

f_37_216: PsaltyrBookFullType = (
    [
        ('30', 5),
        ('31', 6),
        ('32', 7),
        ('33', 8),
        ('34', 9),
        ('35', 10),
        ('36', 10),
        ('37', 12),
        ('38', 13),
        ('39', 14),
        ('40', 15),
        ('41', 15),
        ('42', 16),
        ('43', 16),
        ('44', 17),
        ('45', 18),
        ('46', 19),
        ('47', 19),
        ('48', 19),
        ('49', 20),
        ('50', 21),
        ('51', 22),
        ('52', 22),
        ('53', 23),
        ('54', 23),
        ('55', 24),
        ('56', 24),
        ('57', 25),
        ('58', 25),
        ('59', 26),
        ('60', 27),
        ('61', 27),
        ('62', 27),
        ('63', 28),
        ('64', 28),
        ('65', 29),
        ('66', 30),
        ('67', 30),
        ('68', 31),
        ('69', 33),
        ('70', 33),
        ('71', 34),
        ('72', 35),
        ('73', 36),
        ('74', 37),
        ('75', 37),
        ('76', 38),
        ('77', 39),
        ('78', 41),
        ('79', 42),
        ('80', 43),
        ('81', 43),
        ('82', 44),
        ('83', 44),
        ('84', 45),
        ('85', 45),
        ('86', 46),
        ('87', 46),
        ('88', 47),
        ('89', 49),
        ('90', 49),
        ('91', 50),
        ('92', 51),
        ('93', 51),
        ('94', 52),
        ('95', 52),
        ('96', 53),
        ('97', 53),
        ('98', 54),
        ('99', 54),
        ('100', 54),
        ('101', 55),
        ('102', 56),
        ('103', 56),
        ('104', 58),
        ('105', 59),
        ('106', 61),
        ('107', 62),
        ('108', 63),
        ('109', 64),
        ('110', 64),
        ('111', 65),
        ('112', 65),
        ('113', 66),
        ('114', 66),
        ('115', 66),
        ('116', 67),
        ('117', 67),
        ('118', 68),
        ('119', 73),
        ('120', 74),
        ('121', 74),
        ('122', 74),
        ('123', 74),
        ('124', 75),
        ('125', 75),
        ('126', 75),
        ('127', 75),
        ('128', 76),
        ('129', 76),
        ('130', 76),
        ('131', 76),
        ('132', 77),
        ('133', 77),
        ('134', 78),
        ('135', 78),
        ('136', 79),
        ('137', 79),
        ('138', 79),
        ('139', 80),
        ('140', 81),
        ('141', 81),
        ('142', 82),
        ('143', 82),
        ('144', 83),
        ('145', 84),
        ('146', 84),
        ('147', 84),
        ('148', 85),
        ('149', 85),
        ('150', 86),
    ], 0)

f_173i_11: PsaltyrBookFullType = (
    [
        ('1', 9),
        ('2', 10),
        ('3', 10),
        ('4', 10),
        ('5', 11),
        ('6', 11),
        ('7', 12),
        ('8', 13),
        ('9', 13),
        ('10', 15),
        ('11', 15),
        ('12', 15),
        ('13', 16),
        ('14', 16),
        ('15', 16),
        ('16', 17),
        ('17', 17),
        ('18', 20),
        ('19', 20),
        ('20', 21),
        ('21', 21),
        ('22', 23),
        ('23', 23),
        ('24', 23),
        ('25', 24),
        ('26', 25),
        ('27', 25),
        ('28', 26),
        ('29', 26),
        ('30', 27),
        ('31', 28),
        ('32', 29),
        ('33', 30),
        ('34', 31),
        ('35', 32),
        ('36', 33),
        ('37', 35),
        ('38', 36),
        ('39', 36),
        ('40', 37),
        ('41', 38),
        ('42', 39),
        ('43', 39),
        ('44', 40),
        ('45', 41),
        ('46', 42),
        ('47', 42),
        ('48', 43),
        ('49', 44),
        ('50', 45),
        ('51', 46),
        ('52', 46),
        ('53', 47),
        ('54', 47),
        ('55', 48),
        ('56', 49),
        ('57', 49),
        ('58', 50),
        ('59', 51),
        ('60', 52),
        ('61', 52),
        ('62', 53),
        ('63', 53),
        ('64', 54),
        ('65', 54),
        ('66', 55),
        ('67', 56),
        ('68', 57),
        ('69', 59),
        ('70', 60),
        ('71', 61),
        ('72', 62),
        ('73', 63),
        ('74', 64),
        ('75', 65),
        ('76', 65),
        ('77', 66),
        ('78', 69),
        ('79', 70),
        ('80', 71),
        ('81', 72),
        ('82', 72),
        ('83', 73),
        ('84', 73),
        ('85', 74),
        ('86', 75),
        ('87', 75),
        ('88', 76),
        ('89', 78),
        ('90', 79),
        ('91', 80),
        ('92', 81),
        ('93', 81),
        ('94', 82),
        ('95', 83),
        ('96', 83),
        ('97', 84),
        ('98', 84),
        ('99', 85),
        ('100', 85),
        ('101', 85),
        ('102', 87),
        ('103', 88),
        ('104', 89),
        ('105', 91),
        ('106', 93),
        ('107', 95),
        ('108', 95),
        ('109', 97),
        ('110', 97),
        ('111', 97),
        ('112', 98),
        ('113', 98),
        ('114', 99),
        ('115', 100),
        ('116', 100),
        ('117', 100),
        ('118', 101),
        ('119 ?', 109),
        ('120', 109),
        ('121', 109),
        ('122', 110),
        ('123', 110),
        ('124', 110),
        ('125', 110),
        ('126', 111),
        ('127', 111),
        ('128', 111),
        ('129', 112),
        ('130', 112),
        ('131', 112),
        ('132', 113),
        ('133', 113),
        ('134', 113),
        ('135', 114),
        ('136', 115),
        ('137', 116),
        ('138', 116),
        ('139', 117),
        ('140', 118),
        ('141', 118),
        ('142', 119),
        ('143', 119),
        ('144', 120),
        ('145', 121),
        ('146', 122),
        ('147', 122),
        ('148', 123),
        ('149', 123),
        ('150', 124),
    ], 0)

psaltyr_s_vossledovaniem_1: PsaltyrBookFullType = (  # 2eadd685-eb71-40c5-bdec-7e9dc9b7efce
    [
        ('1', 5),
        ('2', 5),
        ('3', 6),
        ('4', 6),
        ('5', 7),
        ('6', 8),
        ('7', 8),
        ('8', 9),
        ('9', 10),
        ('10', 12),
        ('11', 13),
        ('12', 13),
        ('13', 14),
        ('14', 14),
        ('15', 14),
        ('16', 15),
        ('17', 16),
        ('18', 19),
        ('19', 20),
        ('20', 20),
        ('21', 21),
        ('22', 23),
        ('23', 23),
        ('24', 25),
        ('25', 27),
        ('26', 27),
        ('27', 29),
        ('28', 29),
        ('29', 30),
        ('30', 31),
        ('31', 33),
        ('32', 34),
        ('33', 35),
        ('34', 36),
        ('35', 38),
        ('36', 39),
        ('37', 42),
        ('38', 43),
        ('39', 44),
        ('40', 45),
        ('41', 46),
        ('42', 47),
        ('43', 48),
        ('44', 50),
        ('45', 51),
        ('46', 53),
        ('47 ?', 54),
        ('48', 55),
        ('49', 56),
        ('50', 58),
        ('51', 59),
        ('52', 60),
        ('53', 61),
        ('54', 61),
        ('55', 63),
        ('56', 64),
        ('57', 64),
        ('58', 65),
        ('59', 67),
        ('60', 68),
        ('61', 68),
        ('62', 69),
        ('63', 70),
        ('64', 71),
        ('65', 72),
        ('66', 73),
        ('67', 74),
        ('68', 77),
        ('69', 79),
        ('70', 80),
        ('71', 82),
        ('72', 84),
        ('73', 85),
        ('74', 87),
        ('75', 88),
        ('76', 89),
        ('77', 90),
        ('78', 95),
        ('79', 96),
        ('80', 97),
        ('81', 98),
        ('82', 99),
        ('83', 100),
        ('84', 101),
        ('85', 102),
        ('86', 103),
        ('87', 104),
        ('88 тут пропуск листов', 105),
        ('89', 1),
        ('90', 1),
        ('91', 1),
        ('92', 1),
        ('93', 1),
        ('94', 1),
        ('95', 1),
        ('96', 1),
        ('97', 108),
        ('98', 108),
        ('99', 109),
        ('100', 109),
        ('101', 110),
        ('102 ?', 112),
        ('103', 114),
        ('104', 116),
        ('105', 119),
        ('106', 122),
        ('107', 124),
        ('108', 125),
        ('109', 130),
        ('110', 130),
        ('111', 131),
        ('112', 132),
        ('113', 132),
        ('114', 134),
        ('115', 134),
        ('116', 135),
        ('117', 135),
        ('118', 136),
        ('119', 147),
        ('120', 148),
        ('121', 148),
        ('122', 149),
        ('123', 149),
        ('124', 150),
        ('125', 150),
        ('126', 150),
        ('127', 151),
        ('128', 151),
        ('129', 152),
        ('130', 152),
        ('131', 153),
        ('132', 154),
        ('133', 154),
        ('134', 158),
        ('135', 159),
        ('136', 161),
        ('137', 162),
        ('138', 163),
        ('139', 164),
        ('140', 165),
        ('141', 166),
        ('142', 167),
        ('143', 168),
        ('144', 169),
        ('145', 171),
        ('146', 172),
        ('147', 172),
        ('148', 172),
        ('149', 174),
        ('150', 175),
    ], 0)

psaltyr_tolkovaya_s_pribavleniyami: PsaltyrBookFullType = (  # a05ec697-47ed-4ccf-bc2c-5b8025cc8127
    [
        ('1', 7),
        ('2', 11),
        ('3', 13),
        ('4', 15),
        ('5', 17),
        ('6', 20),
        ('7', 22),
        ('8', 24),
        ('9', 26),
        ('10', 35),
        ('11', 37),
        ('12', 38),
        ('13', 40),
        ('14', 42),
        ('15', 44),
        ('16', 46),
        ('17', 50),
        ('18', 61),
        ('19', 65),
        ('20', 67),
        ('21', 70),
        ('22', 77),
        ('23', 78),
        ('24', 81),
        ('25', 86),
        ('26', 89),
        ('27', 93),
        ('28', 96),
        ('29', 100),
        ('30', 102),
        ('31', 108),
        ('32', 112),
        ('33', 116),
        ('34', 121),
        ('35', 128),
        ('36', 132),
        ('37', 142),
        ('38', 147),
        ('39', 151),
        ('40', 156),
        ('41', 160),
        ('42', 164),
        ('43', 166),
        ('44', 172),
        ('45', 178),
        ('46', 181),
        ('47', 183),
        ('48', 186),
        ('49', 191),
        ('50', 197),
        ('51', 203),
        ('52', 205),
        ('53', 207),
        ('54', 209),
        ('55', 214),
        ('56', 217),
        ('57', 220),
        ('58', 224),
        ('59', 228),
        ('60', 232),
        ('61', 233),
        ('62', 236),
        ('63', 239),
        ('64', 241),
        ('65', 245),
        ('66', 250),
        ('67', 251),
        ('68', 261),
        ('69', 270),
        ('70', 271),
        ('71', 277),
        ('72', 282),
        ('73', 288),
        ('74', 294),
        ('75', 296),
        ('76', 300),
        ('77', 305),
        ('78', 321),
        ('79', 325),
        ('80', 329),
        ('81', 333),
        ('82', 335),
        ('83', 339),
        ('84', 342),
        ('85', 345),
        ('86', 349),
        ('87', 351),
        ('88', 356),
        ('89', 366),
        ('90', 373),
        ('91', 384),
        ('92', 388),
        ('93', 391),
        ('94', 394),
        ('95', 399),
        ('96', 403),
        ('97', 407),
        ('98', 410),
        ('99', 412),
        ('100', 413),
        ('101', 416),
        ('102 ?', 423),
        ('103', 428),
        ('104', 438),
        ('105', 449),
        ('106', 460),
        ('107', 472),
        ('108', 476),
        ('109', 483),
        ('110', 485),
        ('111', 488),
        ('112', 491),
        ('113', 493),
        ('114', 499),
        ('115', 501),
        ('116', 502),
        ('117', 503),
        ('118', 509),
        ('119', 542),
        ('120', 544),
        ('121', 545),
        ('122', 547),
        ('123', 548),
        ('124', 549),
        ('125', 551),
        ('126', 552),
        ('127', 554),
        ('128', 555),
        ('129', 557),
        ('130', 558),
        ('131', 559),
        ('132', 563),
        ('133', 564),
        ('134', 565),
        ('135', 569),
        ('136', 574),
        ('137', 577),
        ('138', 579),
        ('139', 586),
        ('140', 589),
        ('141', 592),
        ('142', 593),
        ('143', 597),
        ('144', 602),
        ('145', 607),
        ('146', 610),
        ('147', 613),
        ('148', 615),
        ('149', 618),
        ('150', 620),
    ], 0)

psaltyr_8: PsaltyrBookFullType = (  # 44e98e44-f6a7-43bb-bd45-c56bc603e93d
    [
        ('1', 3),
        ('2', 5),
        ('3', 7),
        ('4', 8),
        ('5', 10),
        ('6', 13),
        ('7', 14),
        ('8', 17),
        ('9', 19),
        ('10', 26),
        ('11', 27),
        ('12', 29),
        ('13', 30),
        ('14', 31),
        ('15', 32),
        ('16', 34),
        ('17', 37),
        ('18', 46),
        ('19', 48),
        ('20', 50),
        ('21', 53),
        ('22', 58),
        ('23', 59),
        ('24', 61),
        ('25', 64),
        ('26', 66),
        ('27', 69),
        ('28', 71),
        ('29', 73),
        ('30', 75),
        ('31', 80),
        ('32', 82),
        ('33', 85),
        ('34', 88),
        ('35', 93),
        ('36', 95),
        ('37', 101),
        ('38', 105),
        ('39', 107),
        ('40', 111),
        ('41', 113),
        ('42', 116),
        ('43', 117),
        ('44', 121),
        ('45', 125),
        ('46', 127),
        ('47', 128),
        ('48', 130),
        ('49', 133),
        ('50', 137),
        ('51', 141),
        ('52', 143),
        ('53', 144),
        ('54', 145),
        ('55', 149),
        ('56', 151),
        ('57', 153),
        ('58', 155),
        ('59', 158),
        ('60', 160),
        ('61', 161),
        ('62', 163),
        ('63', 165),
        ('64', 167),
        ('65', 170),
        ('66', 173),
        ('67', 174),
        ('68', 180),
        ('69', 186),
        ('70', 187),
        ('71', 191),
        ('72', 195),
        ('73', 199),
        ('74', 203),
        ('75', 205),
        ('76', 207),
        ('77', 210),
        ('78', 221),
        ('79', 223),
        ('80', 226),
        ('81', 228),
        ('82', 229),
        ('83', 232),
        ('84', 233),
        ('85', 235),
        ('86', 238),
        ('87', 239),
        ('88', 242),
        ('89', 251),
        ('90', 255),
        ('91', 257),
        ('92', 260),
        ('93', 261),
        ('94', 264),
        ('95', 266),
        ('96', 268),
        ('97', 271),
        ('98', 272),
        ('99', 274),
        ('100', 275),
        ('101', 276),
        ('102', 281),
        ('103', 284),
        ('104', 290),
        ('105', 296),
        ('106', 303),
        ('107', 310),
        ('108', 312),
        ('109', 317),
        ('110', 318),
        ('111', 320),
        ('112', 321),
        ('113', 322),
        ('114', 326),
        ('115', 327),
        ('116', 328),
        ('117', 328),
        ('118', 332),
        ('119', 357),
        ('120', 358),
        ('121', 359),
        ('122', 360),
        ('123', 361),
        ('124', 362),
        ('125', 363),
        ('126', 364),
        ('127', 365),
        ('128', 367),
        ('129', 367),
        ('130', 367),
        ('131', 368),
        ('132', 370),
        ('133', 371),
        ('134', 371),
        ('135', 374),
        ('136', 377),
        ('137', 378),
        ('138', 380),
        ('139', 384),
        ('140', 384),
        ('141', 384),
        ('142', 384),
        ('143', 384),
        ('144', 384),
        ('145', 399),
        ('146', 401),
        ('147', 402),
        ('148', 404),
        ('149', 404),
        ('150', 407),
    ], 0)


def get_psaltyr_bookmarks(psaltyr_book: PsaltyrBookFullType) -> list[PsaltyrBookmark]:
    psaltyr_bookmarks: list[PsaltyrBookmark] = []
    start_on_new_page: bool = False
    for title, page_num in psaltyr_book[0]:
        num: int = int(title.split(' ')[0])
        color: Color | None = Color(_ColorHex.red_darken_2.value) if '?' not in title else None
        bookmark = PsaltyrBookmark(
            page_num=page_num,
            start_on_new_page=start_on_new_page,
            title=f'Псалом {utils.Cyrillic.to_cyrillic(num)} ({num})',
            color=color,
        )
        psaltyr_bookmarks.append(bookmark)
    return psaltyr_bookmarks


def get_manuscript_created_pdf_path(
        manuscript: models.Manuscript
) -> Path:
    try:
        created_pdf_path: Path = utils.PrepareManuscriptPathFactory.from_lib(
            fund_title=manuscript.fund.title,
            library_title=manuscript.fund.library,
            code=manuscript.code,
        ).created_pdf_path
    except FileNotFoundError as e:
        raise ValueError(e.args[0])
    return created_pdf_path


if __name__ == '__main__':
    for code, psaltyr_book in [
                    ('f-304i-87', f_304i_87),
                    ('f-37-216', f_37_216),
                    ('f-173i-11', f_173i_11),
                    ('2eadd685-eb71-40c5-bdec-7e9dc9b7efce', psaltyr_s_vossledovaniem_1),
                    ('a05ec697-47ed-4ccf-bc2c-5b8025cc8127', psaltyr_tolkovaya_s_pribavleniyami),
                    ('44e98e44-f6a7-43bb-bd45-c56bc603e93d', psaltyr_8)
                ]:
        db: Session = next(deps.get_db())
        manuscript: models.Manuscript = crud.manuscript.get_by_code(db, code=code)
        created_pdf_path = get_manuscript_created_pdf_path(manuscript)
        writer = get_pdf_writer(created_pdf_path)
        bookmarks = get_psaltyr_bookmarks(psaltyr_book)
        add_bookmarks(writer, bookmarks=bookmarks)
        save_pdf(writer, path=created_pdf_path)
        logging.info(created_pdf_path)
